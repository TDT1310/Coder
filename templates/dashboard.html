<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<!--Icon-->
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-thin-rounded/css/uicons-thin-rounded.css'>
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>

<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FraudDetect Pro Dashboard</title>
<style>
  :root {
    --color-primary: #1e40af;
    --color-primary-light: #3b82f6;
    --color-primary-dark: #1b399c;
    --color-text-main: #4f5871;
    --color-text-muted: #6c6c6c;
    --color-text-light: #9e9e9e;
    --color-bg: #f1f6fb;
    --border-radius: 6px;
    --border-radius-lg: 12px;
    --font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }
  * { box-sizing: border-box; }
  body {
    margin:0;
    font-family: var(--font-family);
    background: var(--color-bg);
    color: var(--color-text-main);
    font-size: 14px;
    line-height: 1.5;
  }
  a {
    color: #2563eb;
    text-decoration: none;
    cursor: pointer;
  }
  a:hover { text-decoration: underline; }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px 16px 60px;
  }
  header {
    background: #fff;
    padding: 10px 20px;
    font-size: 14px;
    border-bottom: 1px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #1e40af;
    border-radius: 0;      /* Remove any rounding */
    box-shadow: none;      /* Remove any shadow */
    margin-bottom: 0;      /* Remove extra spacing */
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    font-size: 16px;
    color: #1e40af;
  }
  .logo svg {
    width: 20px;
    height: 20px;
    fill: #2563eb;
    margin-right: 8px;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  button, .btn-blue, .btn-white, .download-pdf, .download-excel {
    font-weight: 600;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
    border: none;
    font-size: 14px;
    white-space: nowrap;
  }
  .download-pdf {
    background-color: #2563eb;
    color: white;
  }
  .download-excel {
    background-color: #22c55e;
    color: white;
  }
  .btn-blue {
    background-color: #2563eb;
    color: white;
    flex: 1;
  }
  .btn-white {
    background-color: white;
    color: #2563eb;
    border: 2px solid #2563eb;
    flex: 1;
  }
  .user-profile {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: url('https://i.pravatar.cc/36') center/cover no-repeat;
    border: 2px solid #2563eb;
  }
  .main-title {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 24px 16px;
    border-bottom: 1px solid #e5e7eb;
    flex-wrap: wrap;
    background: white;
    border-radius: 8px;
    box-shadow: none;
  }
  .main-title-left {
    max-width: 70%;
  }
  .main-title-left h1 {
    font-weight: 700;
    font-size: 1.75rem;
    margin: 0 0 8px 0;
    color: #1f2937;
  }
  .report-details, .submitter-info {
    font-size: 0.875rem;
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    color: #6b7280;
    font-weight: 500;
    align-items: center;
  }
  .report-details span, .submitter-info {
    white-space: nowrap;
  }
  .submitter-info svg {
    width: 18px;
    height: 18px;
    fill: #6b7280;
  }
  .cards-row, .bottom-row {
    display: flex;
    gap: 16px;
    margin: 24px 0;
    flex-wrap: wrap;
    background: none;
    border-radius: 0;
    box-shadow: none;
  }
  .card {
    flex: 1 1 calc(25% - 12px);
    min-width: 260px;
    padding: 20px 16px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    background: white;
    border-radius: 8px;
    box-shadow: 5px px 30px rgb(0 0 0 / 0.05);
    margin-bottom: 0;
  }
  .left-column, .right-column {
    flex: 1 1 48%;
    min-width: 320px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .mscore-analysis, .benford-analysis, .recommendations {
    padding: 16px 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.05);
  }
  .expand-link {
    position: absolute;
    top: 16px;
    right: 20px;
    font-size: 0.875rem;
    color: #2563eb;
    font-weight: 600;
    cursor: pointer;
  }
  .current-value {
    font-size: 0.75rem;
    color: #1d4ed8;
    font-weight: 500;
    margin-bottom: 8px;
  }
  .threshold-volatility {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 12px;
    display: flex;
    gap: 16px;
    align-items: center;
  }
  .threshold-volatility svg { width: 14px; height: 14px; fill: #22c55e; }
  .contrib-factors { margin-bottom: 8px; }
  .contrib-factors ul { margin: 4px 0 12px 16px; padding: 0; }
  .contrib-factors li { margin-bottom: 6px; }
  .yoy-value { font-weight: 600; font-size: 0.875rem; color: #2563eb; margin-bottom: 8px; }
  .small-line-graph { height: 50px; background: linear-gradient(to right, #dbeafe, #2563eb); border-radius: 6px; }
  .benford-analysis h3, .recommendations h3 {
    font-weight: 700;
    font-size: 1rem;
    margin: 0 0 12px 0;
    color: #1f2937;
  }
  .recommendations {
    padding: 20px 24px;
    margin-top: 24px;
  }
  .recommendations ul { margin-bottom: 20px; padding-left: 20px; list-style-type: disc; color: #374151; }
  .recommendations ul li {
    margin-bottom: 6px;
    font-size: 0.875rem;
  }
  .rec-buttons { display: flex; gap: 12px; }
  /* Footer */
  footer {
    margin-top: 40px;
    padding: 20px 16px;
    text-align: center;
    font-size: 0.75rem;
    color: #6b7280;
    border-top: 1px solid #e5e7eb;
  }
  svg.icon { vertical-align: middle; }
  @media (max-width: 1024px) {
    .cards-row, .bottom-row { flex-wrap: wrap; }
    .card { flex: 1 1 45%; }
    .left-column, .right-column { flex: 1 1 100%; min-width: auto; }
    .recommendations { margin-left: 0; max-width: 100%; }
  }
  @media (max-width: 480px) {
    .main-title-left { max-width: 100%; margin-bottom: 12px; }
    .submitter-info { justify-content: flex-start; }
    .header-right { gap: 8px; }
  }
  .delta-positive {
    color: green;
    font-weight: 600;
  }
  .delta-negative {
    color: red;
    font-weight: 600;
  }
  .delta-neutral {
    color: gray;
    font-weight: 600;
  }
</style>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<header>
  <div class="logo" aria-label="FraudDetect Pro Logo">
    <i class="fi fi-rr-spy" style="font-size: 20px; color: #1e40af;"></i>
    FraudDetect Pro
  </div>
  <div class="header-right">
    <button class="download-pdf" aria-label="Download PDF">Download PDF</button>
  </div>
</header>

<main class="container">
  <section class="main-title" aria-labelledby="dashboard-title">
    <div class="main-title-left">
      <div class="label" style="font-weight: 700; color: #1e40af; font-size: 1rem;">Financial Report Fraud Analysis</div>
      <div class="report-details" role="list">
        <span role="listitem">ðŸ“… Analysis Period: <strong>{{ selected_period }}</strong></span>
        <span role="listitem">ðŸ“„ Type: <strong> Annual</strong></span>
        <span role="listitem">ðŸ“Š Data Scope: <strong> Full Statements</strong></span>
      </div>
    </div>
    <form method="get" action="{{ url_for('dashboard') }}" style="display:flex; align-items:center; gap:12px; margin-top:12px;">
      <select name="selected_period" style="border:1px solid #d1d5db; border-radius:8px; padding:6px 16px; font-size:1rem; font-family:inherit; outline:none;">
        {% for period in periods %}
          <option value="{{ period }}" {% if period == selected_period %}selected{% endif %}>{{ period }}</option>
        {% endfor %}
      </select>
      <button type="submit" style="background:#2563eb; color:#fff; border:none; border-radius:8px; padding:8px 20px; font-size:1rem; font-weight:600; cursor:pointer;">Update Analysis</button>
    </form>
  </section>

  <!-- Cards -->
  <section class="cards-row" aria-label="Summary Cards">
    <article class="card" role="region" aria-labelledby="overall-fraud-status-title"
      style="background:white; color:black;">
      <div class="card-header" style="flex-direction:column; gap:2px;">
        <i class="fi fi-rr-analytics-magnifying-glass" style="font-size: 30px; color: #eab308;"></i>
        <div class="label" id="overall-fraud-status-title">Overall Fraud Status</div>
        <div class="value" id="overall-fraud-status-value" style="font-weight:700; font-size:1.35rem; margin-bottom:4px; color: #a16207;">
          {{ session['rag_conclusion'] if session['rag_conclusion'] else 'Review Needed' }}
        </div>
        <!-- This card now always shows the RAG risk analysis conclusion, not a score -->
      </div>
    </article>

    <article class="card" role="region" aria-labelledby="mscore-title"
      style="background:white; color:black;">
      <div class="card-header" style="flex-direction:column; gap:2px;">
        <i class="fi fi-rr-chart-histogram" style="font-size: 30px; color: #3b82f6;"></i>
        <div class="label" id="mscore-title">M-Score (Beneish)</div>
        <div class="value" style="font-size:1.35rem; font-weight:700; margin-bottom:2px; color: #1d4ed8;">
          {{ m_score if m_score is not none else "N/A" }}
        </div>
        <div class="benchmark" style="font-size:0.75rem; color:#6b7280; margin-bottom:6px;">Threshold: <span style="font-size:0.875rem; color:#3b82f6; margin-bottom:6px; font-weight: 500;">-2.22 </span> </div>
        {% if m_score is not none %}
          {% if m_score < -2.22 %}
            <div class="warning" style="font-size:0.65rem; color:#10b981; font-weight:600; background: #d1fae5; border-radius: 16px; padding: 3px 5px; max-width: fit-content ;margin: auto;">
              Unlikely Manipulator
            </div>    
          {% elif m_score < -1.78 %}
            <div class="warning" style="font-size:0.65rem; color:#f59e0b; font-weight:600; background: #fef9c3; border-radius: 16px; padding: 3px 5px; max-width: fit-content ;margin: auto;">
              Possible
            </div>
          {% else %}
            <div class="warning" style="font-size:0.65rem; color:#ec4899; font-weight:600; background: #fee2e2; border-radius: 16px; padding: 3px 5px; max-width: fit-content ;margin: auto;">
              Likely Manipulation
            </div>
          {% endif %}
        {% else %}
          <div class="warning" style="font-size:0.65rem; color:#6b7280; font-weight:600; background: #e5e7eb; border-radius: 16px; padding: 3px 5px; max-width: fit-content ;margin: auto;">
            No M-Score Available
          </div>
        {% endif %}
        </div>
      </div>
    </article>

    <article class="card" role="region" aria-labelledby="benford-title"
      style="background: white; color:black;">
      <div class="card-header" style="flex-direction:column; gap:2px;">
        <i class="fi fi-rr-curve-arrow" style="font-size: 30px; color: #ec4899;"></i>
        <div class="label" id="benford-title">Benford Deviation</div>
        <div class="value" style="font-weight:700; font-size:1.35rem; margin-bottom:2px; color: #be1862">
          {% if mad is not none %}
            {% if mad > 0.012 %}
              <span style="color:#ec4899; font-weight:600;">High</span>
            {% elif mad > 0.006 %}
              <span style="color:#f59e0b; font-weight:600;">Medium</span>
            {% else %}
              <span style="color:#10b981; font-weight:600;">Low</span>
            {% endif %}
          {% else %}
            <span style="color:#6b7280;">N/A</span>
          {% endif %}
        </div>
        <div class="benchmark" style="font-size:0.75rem; color:#6b7280; margin-bottom:6px;">
          MAD: <span style="font-size:0.875rem; color:#ec4899; margin-bottom:6px; font-weight: 500;">
            {{ mad if mad is not none else "N/A" }}
          </span>
        </div>
        {% if mad is not none %}
          {% if mad > 0.012 %}
            <div class="warning" style="font-size:0.65rem; color: #ec4899; font-weight:600; background: #fee2e2; border-radius: 16px; padding: 3px 5px; max-width: fit-content; margin: auto;">
              Significant deviation
            </div>
          {% elif mad > 0.006 %}
            <div class="warning" style="font-size:0.65rem; color: #f59e0b; font-weight:600; background: #fef9c3; border-radius: 16px; padding: 3px 5px; max-width: fit-content; margin: auto;">
              Notable deviation
            </div>
          {% else %}
            <div class="warning" style="font-size:0.65rem; color: #10b981; font-weight:600; background: #d1fae5; border-radius: 16px; padding: 3px 5px; max-width: fit-content; margin: auto;">
              Minimal deviation
            </div>
          {% endif %}
        {% else %}
          <div class="warning" style="font-size:0.65rem; color: #6b7280; font-weight:600; background: #e5e7eb; border-radius: 16px; padding: 3px 5px; max-width: fit-content; margin: auto;">
            No data available
          </div>
        {% endif %}
      </div>
    </article>
  </section>

  <!-- RAG Risk Analysis Block -->
  {% include 'rag_risk_analysis_block.html' %}

  <!-- Recommendations Block -->
  {% include 'recommendation_block.html' %}

  <!-- Analysis row -->
  <section class="bottom-row" aria-label="Detailed Analysis Section">
    <!-- Left Column -->
    <div class="left-column">
      <section class="mscore-analysis" role="region" aria-labelledby="mscore-analysis-title" style="position:relative;">
        {# Set warning label and style for M-Score based on value #}
        {% set mscore_warning_label =
            'Unlikely Manipulator' if m_score is not none and m_score <= -2.22 else
            'Possible' if m_score is not none and m_score > -2.22 and m_score <= -1.78 else
            'Likely Manipulator' if m_score is not none and m_score > -1.78 else
            'N/A' %}
        {% set mscore_warning_style =
            'background:#ecfdf5; color:#059669;' if m_score is not none and m_score <= -2.22 else
            'background:#fdf2f8; color:#ec4899;' if m_score is not none and m_score > -2.22 and m_score <= -1.78 else
            'background:#fef3c7; color:#92400e;' if m_score is not none and m_score > -1.78 else
            'background:#e5e7eb; color:#374151;' %}
        <div class="mscore-status-label"
             style="{{ 'position:absolute; top:16px; right:20px; display:inline-block; font-weight:700; font-size:0.875rem; padding:2px 8px; border-radius:16px; z-index:1;' ~ mscore_warning_style }}">
          {{ mscore_warning_label }}
        </div>
        <h3 id="mscore-analysis-title" style="margin-top:0; font-weight:700; margin-bottom:1px; font-size: 1.5rem;">M-Score Analysis</h3>
        <div class="current-value">
          <span style="color: var(--color-text-main);"> Current Value: </span>
          <span>{{ m_score if m_score is not none else "N/A" }}</span>
        </div>
        <div class="threshold-volatility">
          <span>Threshold: -2.22</span>
          <svg aria-hidden="true" fill="#22c55e" viewBox="0 0 24 24" style="width:14px; height:14px;">
            <path d="M12 2l7 7h-4v7h-6v-7H5l7-7z" />
          </svg>
          <span>Volatility: â†‘</span>
        </div>
        <div class="contrib-factors">
          <strong>Top 3 Variable Changes:</strong>
          <ul class="m-score-change-list">
            {% for var, value, delta, explanation in top_changes %}
              <li>
                <strong>{{ var }}</strong>: {{ "%.4f"|format(value) }}
                {% if delta is not none %}
                  (<span class="{% if delta > 0 %}delta-positive{% elif delta < 0 %}delta-negative{% else %}delta-neutral{% endif %}">
                    {{ "+" if delta > 0 else "" }}{{ "%.4f"|format(delta) }}
                  </span>)
                {% endif %}
                <span title="{{ explanation }}" style="cursor: help; color: #6366f1; font-weight: bold; margin-left: 6px;">&#9432;</span>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- M-Score Components Bar Chart -->
        <div style="margin: 18px 0 0 0;">
          <div style="font-weight:600; color:#1d4ed8; font-size:1rem; margin-bottom:20px; text-align: center;">Component Comparison (Current vs Previous)</div>
          <div id="mscore-components-bar-chart" style="width:100%;max-width:500px;height:240px;margin:auto;overflow:hidden;"></div>
          {% if mscore_components_bar_data %}
          <script>
          const mscoreComponentsBarData = JSON.parse('{{ mscore_components_bar_data|safe }}');
          if (mscoreComponentsBarData && mscoreComponentsBarData.variables && mscoreComponentsBarData.current && mscoreComponentsBarData.previous) {
              const traceCurrent = {
                  x: mscoreComponentsBarData.variables,
                  y: mscoreComponentsBarData.current,
                  name: mscoreComponentsBarData.current_label || 'Current',
                  type: 'bar',
                  marker: {color: '#1d4ed8'},
                  opacity: 0.5,
              };
              const tracePrev = {
                  x: mscoreComponentsBarData.variables,
                  y: mscoreComponentsBarData.previous,
                  name: mscoreComponentsBarData.previous_label || 'Previous',
                  type: 'bar',
                  marker: {color: '#be1862'},
                  opacity: 0.5,
              };
              const layout = {
                  barmode: 'group',
                  title: '',
                  xaxis: {title: 'Component', tickfont: {size: 12}},
                  yaxis: {title: 'Value', tickfont: {size: 12}},
                  legend: {orientation: 'h', y: -0.7},
                  plot_bgcolor: '#fff',
                  autosize: true,
                  margin: { t: 10, l: 30, r: 10, b: 80 },
                  height: 240,
                  width: 500 // Reduced size to match Benford chart
              };
              Plotly.newPlot('mscore-components-bar-chart', [traceCurrent, tracePrev], layout, {responsive: true});
          }
          </script>
          {% endif %}
        </div>
      </section>
    </div>

    <!-- Right Column -->
    <div class="right-column">
      <section class="benford-analysis" role="region" aria-labelledby="benford-analysis-title"
        style="position:relative; min-height:420px; height:100%; display:flex; flex-direction:column; justify-content:space-between;">
        <div style="flex:0 0 auto;">
          <div class="warning-label"
               style="position:absolute; top:16px; right:20px; display:inline-block; background:#fef3c7; color:#ec4899; font-weight:700; font-size:0.875rem; padding:2px 8px; border-radius:16px; z-index:1;">
            {% if mad is not none %}
              {% if mad > 0.012 %}
                <span style="color:#ec4899; font-weight:600;">High</span>
              {% elif mad > 0.006 %}
                <span style="color:#f59e0b; font-weight:600;">Medium</span>
              {% else %}
                <span style="color:#10b981; font-weight:600;">Low</span>
              {% endif %}
            {% else %}
              <span style="color:#6b7280;">N/A</span>
            {% endif %}
          </div>
          <h3 id="benford-analysis-title" style="margin-top:0; font-weight:700; margin-bottom:1px; font-size: 1.5rem;">Benford Analysis</h3>
          <div class="current-value">
            <span style="color: var(--color-text-main);">MAD Deviation:</span>
            <span style="color:#ec4899; font-weight:700;">{{ mad if mad is not none else "N/A" }}</span>
          </div>
          <div class="threshold-volatility">
            <span>Deviation Level:</span>
            {% if mad is not none %}
              {% if mad > 0.012 %}
                <span style="color:#ec4899; font-weight:600;">High</span>
              {% elif mad > 0.006 %}
                <span style="color:#f59e0b; font-weight:600;">Medium</span>
              {% else %}
                <span style="color:#10b981; font-weight:600;">Low</span>
              {% endif %}
            {% else %}
              <span style="color:#6b7280;">N/A</span>
            {% endif %}
          </div>
          {% if mad is not none %}
            <p class="text-muted small" style="margin-top: 6px;">
              {% if mad > 0.012 %}
                This dataset is <strong>inconsistent</strong> with what we'd expect from Benford's Law. Significant deviations may indicate manipulation.
              {% elif mad > 0.006 %}
                This dataset is generally consistent with Benford's Law, but some deviations may need further review.
              {% else %}
                This dataset is <strong>consistent</strong> with what we'd expect from Benford's Law. No signs of irregularity.
              {% endif %}
            </p>
          {% endif %}
        </div>
        <div class="benford-charts" aria-hidden="true" style="flex:1 1 auto; display:flex; flex-direction:column; justify-content:flex-end; align-items:center; min-height:340px;">
          <div style="font-weight:600; color:#1d4ed8; font-size:1rem; margin-bottom:20px; text-align: center; min-height:24px;">Leading Digit Distribution Analysis</div>
          <div id="benford-interactive-chart" style="width:100%;max-width:500px;height:240px;margin:auto;overflow:hidden;"></div>
          {% if plotly_benford_data %}
          <script>
          const benfordData = JSON.parse('{{ plotly_benford_data|safe }}');
          if (benfordData && benfordData.x && benfordData.benford && benfordData.actual) {
            const trace1 = {
              x: benfordData.x,
              y: benfordData.benford,
              name: "Benford (%)",
              type: 'bar',
              marker: { color: '#F48FB1' },
              opacity: 0.7,
              hovertemplate: 'Benford (%): %{y:.2f}<extra></extra>',
            };
            const trace2 = {
              x: benfordData.x,
              y: benfordData.actual,
              name: "Actual (%)",
              type: 'bar',
              marker: { color: '#4FC3F7' },
              opacity: 0.8,
              hovertemplate: 'Actual (%): %{y:.2f}<extra></extra>',
            };
            const layout = {
              barmode: 'group',
              title: '',
              xaxis: {
                title: 'Leading Digit',
                tickfont: { size: 12 },
              },
              yaxis: {
                title: 'Percentage',
                tickfont: { size: 12 },
              },
              legend: {
                orientation: 'h',
                y: -0.7,
              },
              plot_bgcolor: '#ffffff',
              margin: { t: 10, l: 30, r: 10, b: 80 },
              height: 240,
              width: 500 // Reduced size to match new container
            };
            Plotly.newPlot('benford-interactive-chart', [trace1, trace2], layout, {responsive: true});
          }
          </script>
          {% endif %}
        </div>
        <div class="benford-legend">
          <span><span class="benford-legend-color benford-actual"></span></span>
          <span><span class="benford-legend-color benford-expected"></span></span>
        </div>
      </section>
    </div>
  </section>

  <!-- M-Score Trend Chart Block (Full Width) -->
  <section class="mscore-trend-block" style="background:white; border-radius:8px; margin:24px 0; padding:24px 24px 12px 24px; box-shadow:0 2px 8px rgb(0 0 0 / 0.05);">
    <h3 style="font-weight:700; font-size:1.25rem; color:#1d4ed8; margin-bottom:12px;">M-Score Trend (All Periods)</h3>
    <div id="mscore-interactive-chart" style="width:100%;height:320px;"></div>
    {% if mscore_plotly_data %}
    <script>
    const mscoreData = JSON.parse('{{ mscore_plotly_data|safe }}');
    if (mscoreData && mscoreData.x && mscoreData.y) {
        const trace = {
            x: mscoreData.x,
            y: mscoreData.y,
            type: 'scatter',
            mode: 'lines+markers+text',
            name: 'M-Score',
            line: { color: '#1d4ed8', width: 3 },
            marker: { color: '#1d4ed8', size: 8 },
            text: mscoreData.y.map(y => y.toFixed(2)),
            textposition: 'top center'
        };
        const layout = {
            title: "M-Score Over Time",
            xaxis: { title: "Period" },
            yaxis: { title: "M-Score" },
            plot_bgcolor: "#fff",
            autosize: true,
            margin: { t: 40, l: 40, r: 20, b: 40 }
        };
        Plotly.newPlot('mscore-interactive-chart', [trace], layout, {responsive: true});
    }
    </script>
    {% endif %}
  </section>

  <!-- Question & Answer Block (styled like other sections, above Recommendations) -->
  <section class="qa-block" style="background:white; border-radius:8px; margin:24px 0 0 0; padding:24px 24px 18px 24px; box-shadow:0 2px 8px rgb(0 0 0 / 0.05);">
    <h3 style="font-weight:700; font-size:1.25rem; color:#1d4ed8; margin-bottom:12px;">Ask a Question</h3>
    <form id="qa-form" style="display:flex; gap:12px; align-items:center; margin-bottom:0;">
        <input type="text" id="user_question" name="user_question" placeholder="Ask a question..." required
               style="flex:1; padding:10px 14px; border:1px solid #d1d5db; border-radius:8px; font-size:1rem; font-family:inherit;">
        <button type="submit" class="btn-blue" style="padding:6px 14px; font-size:0.95rem; min-width:60px; flex:0 0 auto;">Ask</button>
    </form>
    <div id="qa-answer-block" style="margin-top:1.2em;">
      {% if latest_qa.question %}
        <div style="background:#f1f6fb; border-radius:6px; padding:14px 16px;">
          <b style="color:#1e40af;">Question:</b> {{ latest_qa.question }}<br>
          <b style="color:#1e40af;">Answer:</b> {{ latest_qa.answer|safe }}<br>
        </div>
      {% endif %}
    </div>
  </section>
  <script>
  document.getElementById('qa-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const question = document.getElementById('user_question').value;
      // Show the "Generating answer..." message
      document.getElementById('qa-answer-block').innerHTML = '<div style="background:#f1f6fb; border-radius:6px; padding:14px 16px;">' +
              '<b style="color:#1e40af;">Q:</b> ' + question + '<br>' +
              '<b style="color:#1e40af;">A:</b> Generating answer...' +
              '</div>';
      fetch('/ask', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: 'user_question=' + encodeURIComponent(question)
      })
      .then(response => response.text())
      .then(answerHtml => {
          document.getElementById('qa-answer-block').innerHTML =
              '<div style="background:#f1f6fb; border-radius:6px; padding:14px 16px;">' +
              '<b style="color:#1e40af;">Q:</b> ' + question + '<br>' +
              '<b style="color:#1e40af;">A:</b> ' + answerHtml +
              '</div>';
      });
  });
  </script>

  <!-- Recommendations & Next Steps (now below Q&A block) -->
  <section class="recommendations" role="region" aria-labelledby="recommendations-title">
    <h3 id="recommendations-title">Recommendations &amp; Next Steps</h3>
    <ul>
      <li>Initiate management discussion for accounts receivable justifications</li>
      <li>Conduct deeper audit on miscellaneous income &amp; cash flow discrepancies</li>
      <li>Review and clarify adjustment entries in notes</li>
    </ul>
    <div class="rec-buttons">
      <button class="btn-blue" aria-label="Notify Management">Notify Management</button>
      <button class="btn-white" aria-label="Reference Materials">Reference Materials</button>
    </div>
  </section> 
  
</main>

<footer>
  Â© 2024 FraudDetect Pro â€” Financial Report Fraud Detection Platform. All rights reserved.
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.querySelector('.download-pdf').addEventListener('click', function () {
  // Select the main content you want to export
  const content = document.body;
  html2canvas(content).then(canvas => {
    const imgData = canvas.toDataURL('image/png');  
    const pdf = new window.jspdf.jsPDF({
      orientation: 'portrait',
      unit: 'pt',
      format: 'a4'
    });
    // Calculate width/height for A4
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = pageWidth;
    const imgHeight = canvas.height * imgWidth / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    pdf.save('dashboard.pdf');
  });
});

// Add this block for dynamic warning label color:
document.querySelectorAll('.warning-label').forEach(function(label) {
  const level = label.textContent.trim().toLowerCase();
  if (level === 'warning' || level === 'high') {
    label.style.background = '#fef3c7';
    label.style.color = '#92400e';
  } else if (level === 'medium') {
    label.style.background = '#fdf2f8';
    label.style.color = '#ec4899';
  } else if (level === 'low') {
    label.style.background = '#ecfdf5';
    label.style.color = '#059669';
  } else {
    label.style.background = '#e5e7eb';
    label.style.color = '#374151';
  }
});
// Add this block for dynamic M-Score status label color:
document.querySelectorAll('.mscore-status-label').forEach(function(label) {
  const level = label.textContent.trim().toLowerCase();
  if (level === 'unlikely manipulator') {
    label.style.background = '#ecfdf5';
    label.style.color = '#059669';
  } else if (level === 'possible') {
    label.style.background = '#fef3c7';
    label.style.color = '#92400e';
  } else if (level === 'likely manipulator') {
    label.style.background = '#fdf2f8';
    label.style.color = '#ec4899';
  } else {
    label.style.background = '#e5e7eb';
    label.style.color = '#374151';
  }
});
</script>
<form id="period-form" style="display:flex; align-items:center; gap:12px; margin-top:12px;">
  <select name="selected_period" id="selected_period">
    {% for period in periods %}
      <option value="{{ period }}" {% if period == selected_period %}selected{% endif %}>{{ period }}</option>
    {% endfor %}
  </select>
</form>

<div id="analysis-block">
  {# Place your analysis/chart block here as usual #}
  <!-- Hidden span for JS update: always shows the RAG conclusion, not a score -->
  <span id="rag-conclusion-value" style="display:none;">
    {{ session['rag_conclusion'] if session['rag_conclusion'] else 'Review Needed' }}
  </span>
</div>

<script>
document.getElementById('selected_period').addEventListener('change', function() {
    const period = this.value;
    fetch(`/dashboard_analysis?selected_period=${encodeURIComponent(period)}`)
      .then(response => response.text())
      .then(html => {
        document.getElementById('analysis-block').innerHTML = html;
        // Update the summary card value from the hidden span in the new analysis block
        const newConclusion = document.getElementById('rag-conclusion-value')?.textContent?.trim();
        if (newConclusion) {
          document.getElementById('overall-fraud-status-value').textContent = newConclusion;
        }
        // If your charts need to be re-initialized, you may need to call Plotly.newPlot again here.
      });
});
</script>
</body>
</html>
